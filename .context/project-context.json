{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "context_metadata": {
    "project_name": "photo-monorepo",
    "project_type": "Full-Stack Web Application",
    "version": "1.0.0",
    "context_fingerprint": "photo-monorepo-2026-01-14-initial",
    "captured_at": "2026-01-14T22:05:00Z",
    "capture_type": "comprehensive",
    "last_git_commit": "7c28e0a feat: 完成 Phase 1 基础设施搭建 - 现代化 Monorepo 架构"
  },
  "project_overview": {
    "description": "Photo Collection Management System - A web-based photo collection system where users upload photos via access codes, and administrators manage/download photos through a backend dashboard",
    "primary_language": "TypeScript/Python",
    "architecture_pattern": "Monorepo with Microservices",
    "deployment_strategy": "Docker Compose",
    "current_status": "Phase 1 Complete - Infrastructure Setup Done",
    "completion_percentage": "11%",
    "project_repository": "https://github.com/ZipperCode/photo-monorepo"
  },
  "technology_stack": {
    "frontend": {
      "framework": "Vue 3",
      "language": "TypeScript",
      "build_tool": "Vite",
      "ui_library": "Element Plus",
      "css_framework": "Tailwind CSS",
      "state_management": "Pinia",
      "routing": "Vue Router",
      "applications": [
        {
          "name": "web",
          "port": 5173,
          "description": "User-facing frontend for photo uploads",
          "entry_point": "apps/web/src/main.ts"
        },
        {
          "name": "admin",
          "port": 5174,
          "description": "Administrator dashboard for photo management",
          "entry_point": "apps/admin/src/main.ts"
        }
      ]
    },
    "backend": {
      "framework": "FastAPI",
      "language": "Python 3.11+",
      "async_support": true,
      "orm": "Beanie ODM (based on Motor)",
      "authentication": "JWT",
      "image_processing": "Pillow",
      "package_manager": "uv",
      "port": 8000,
      "entry_point": "apps/server/app/main.py",
      "api_documentation": "http://localhost:8000/docs (auto-generated)"
    },
    "database": {
      "primary": "MongoDB 7.0",
      "port": 27017,
      "admin_interface": "Mongo Express (port 8081)",
      "connection_pattern": "Async via Motor"
    },
    "monorepo_tools": {
      "task_orchestration": "Nx",
      "package_manager": "pnpm",
      "workspace_structure": "pnpm workspaces",
      "type_generation": "OpenAPI → TypeScript (schema-first)"
    },
    "deployment": {
      "containerization": "Docker",
      "orchestration": "Docker Compose",
      "reverse_proxy": "Nginx (port 80)",
      "services_count": 6,
      "services": ["mongodb", "mongo-express", "server", "web", "admin", "nginx"]
    }
  },
  "project_structure": {
    "monorepo_layout": {
      "apps": {
        "web": "Vue 3 user frontend (port 5173)",
        "admin": "Vue 3 admin dashboard (port 5174)",
        "server": "FastAPI backend (port 8000)"
      },
      "packages": {
        "ui": "Shared Vue component library",
        "configs": "Shared configuration (ESLint, Tailwind, Vite)",
        "schema": "OpenAPI schema and TypeScript types"
      },
      "infrastructure": {
        "docker": "Dockerfiles for all services",
        "scripts": "Utility scripts"
      },
      "storage": "Local file storage (gitignored)",
      "spec_workflow": "Project specification documents and planning"
    },
    "key_directories": [
      "apps/web",
      "apps/admin",
      "apps/server",
      "packages/ui",
      "packages/configs",
      "packages/schema",
      "infrastructure/docker",
      "infrastructure/scripts",
      "storage/uploads",
      "storage/thumbnails",
      ".spec-workflow/specs"
    ]
  },
  "architectural_decisions": [
    {
      "decision_type": "Database Choice",
      "decision": "MongoDB over PostgreSQL",
      "rationale": "Document-oriented data model suits flexible photo metadata (EXIF), horizontal scalability, schema-less rapid iteration",
      "impact_score": 9,
      "trade_offs": "Less ACID guarantees, no complex joins"
    },
    {
      "decision_type": "Storage Strategy",
      "decision": "Local file system with S3 abstraction layer",
      "rationale": "Lower initial cost, simplified dev setup, easy to migrate to S3 via abstraction layer",
      "impact_score": 7,
      "trade_offs": "Limited scalability initially, manual backup required"
    },
    {
      "decision_type": "Authentication Model",
      "decision": "No user registration, access-code based for users, JWT for admins",
      "rationale": "Simplified user flow, access codes as permission model, prevents abuse via admin-created codes",
      "impact_score": 8,
      "trade_offs": "No user tracking, limited audit capability"
    },
    {
      "decision_type": "Monorepo Architecture",
      "decision": "Nx + pnpm workspaces",
      "rationale": "Unified codebase, shared packages, task caching, consistent tooling",
      "impact_score": 9,
      "trade_offs": "Initial complexity, learning curve for Nx"
    },
    {
      "decision_type": "UI Framework Priority",
      "decision": "Focus on admin dashboard beauty over user frontend",
      "rationale": "Admin is primary user, frequent operations, complex features need good UX",
      "impact_score": 7,
      "trade_offs": "Less polished user-facing frontend initially"
    }
  ],
  "implementation_phases": {
    "total_phases": 9,
    "current_phase": 1,
    "phases": [
      {
        "phase": 1,
        "name": "Infrastructure Setup",
        "priority": "Critical",
        "status": "completed",
        "completion_date": "2026-01-14",
        "deliverables": [
          "Nx task orchestration configuration",
          "pnpm workspace management",
          "FastAPI application framework",
          "Beanie ODM integration",
          "MongoDB connection management",
          "Vue 3 dual applications (web + admin)",
          "Docker compose with 6 services",
          "OpenAPI schema generation",
          "TypeScript type generation"
        ]
      },
      {
        "phase": 2,
        "name": "Authentication System",
        "priority": "High",
        "status": "pending",
        "key_features": [
          "JWT authentication",
          "bcrypt password hashing (cost factor 12)",
          "Admin login endpoint",
          "Route guards",
          "Token management (24h expiry)"
        ]
      },
      {
        "phase": 3,
        "name": "Access Code Management",
        "priority": "Critical",
        "status": "pending",
        "key_features": [
          "6-character alphanumeric codes (case-insensitive)",
          "Random generation with uniqueness check",
          "Code validation endpoint",
          "CRUD operations for admins",
          "Code status management (active/archived/closed)"
        ]
      },
      {
        "phase": 4,
        "name": "Photo Upload System",
        "priority": "Critical",
        "status": "pending",
        "key_features": [
          "Multipart/form-data upload",
          "Local file storage with structured paths",
          "Thumbnail generation (400x400, Pillow)",
          "File validation (magic numbers + MIME)",
          "EXIF metadata extraction",
          "Drag-and-drop UI",
          "Upload progress tracking"
        ]
      },
      {
        "phase": 5,
        "name": "Admin Dashboard UI Design",
        "priority": "Critical (重点)",
        "status": "pending",
        "design_focus": true,
        "key_features": [
          "Modern dashboard with statistics cards",
          "Responsive photo grid (2/4/6 columns)",
          "Photo selection with checkboxes",
          "Batch operations (download/delete)",
          "Lightbox with keyboard navigation",
          "Glassmorphism sticky toolbar",
          "Professional color scheme (blue-based)",
          "SVG icons (Heroicons/Lucide)"
        ],
        "design_tool": "ui-ux-pro-max skill"
      },
      {
        "phase": 6,
        "name": "Statistics and Data Display",
        "priority": "Medium",
        "status": "pending",
        "key_features": [
          "Total collections count",
          "Total photos count",
          "Total storage usage",
          "Recent uploads list",
          "Collection activity statistics"
        ]
      },
      {
        "phase": 7,
        "name": "Search, Filter, and Optimization",
        "priority": "Medium",
        "status": "pending",
        "key_features": [
          "Filename search",
          "Date range filtering",
          "Database indexing optimization",
          "Image lazy loading",
          "Virtual scrolling for large lists"
        ],
        "performance_targets": {
          "first_load": "< 2s",
          "lazy_load_savings": "60% initial bandwidth",
          "virtual_scroll_capacity": "1000+ photos smoothly"
        }
      },
      {
        "phase": 8,
        "name": "Testing and Documentation",
        "priority": "High",
        "status": "pending",
        "coverage_targets": {
          "backend_unit_tests": "> 80%",
          "frontend_component_tests": "> 70%",
          "e2e_tests": "Critical user flows"
        },
        "documentation": [
          "API documentation (FastAPI auto-generated)",
          "User manual (upload flow)",
          "Admin manual (backend operations)",
          "Deployment guide (Docker)",
          "README.md (quick start)"
        ]
      },
      {
        "phase": 9,
        "name": "Production Deployment",
        "priority": "Critical",
        "status": "pending",
        "key_features": [
          "Multi-stage Docker builds",
          "Nginx HTTPS with Let's Encrypt",
          "MongoDB backup scripts",
          "Centralized logging",
          "Environment variable templates",
          "Monitoring and alerting"
        ]
      }
    ]
  },
  "database_schema": {
    "collections": {
      "name": "collections",
      "purpose": "Store access code information",
      "indexes": ["code (unique)", "status", "created_at"],
      "fields": {
        "_id": "ObjectId",
        "code": "String (unique, 6-char alphanumeric)",
        "name": "String",
        "description": "String",
        "status": "Enum: active | archived | closed",
        "settings": {
          "allow_upload": "Boolean",
          "max_file_size": "Number (bytes)",
          "allowed_extensions": "Array<String>"
        },
        "statistics": {
          "total_photos": "Number",
          "total_size_bytes": "Number",
          "last_upload_at": "Date"
        },
        "created_at": "Date",
        "created_by": "String (admin username)"
      }
    },
    "photos": {
      "name": "photos",
      "purpose": "Store photo metadata and file references",
      "indexes": ["collection_code", "uploaded_at", "is_deleted"],
      "fields": {
        "_id": "ObjectId",
        "collection_code": "String (indexed)",
        "filename": "String",
        "file_path": "String",
        "thumbnail_path": "String",
        "file_size": "Number (bytes)",
        "mime_type": "String",
        "dimensions": {
          "width": "Number",
          "height": "Number"
        },
        "uploaded_at": "Date (indexed)",
        "uploader_info": {
          "ip_address": "String",
          "user_agent": "String"
        },
        "metadata": {
          "exif_data": "Object",
          "camera_make": "String",
          "camera_model": "String"
        },
        "processing_status": "Enum: pending | processed | failed",
        "is_deleted": "Boolean"
      }
    },
    "users": {
      "name": "users",
      "purpose": "Store admin user credentials",
      "indexes": ["username (unique)"],
      "fields": {
        "_id": "ObjectId",
        "username": "String (unique)",
        "password_hash": "String (bcrypt)",
        "role": "String (admin)",
        "created_at": "Date",
        "last_login_at": "Date"
      }
    }
  },
  "api_endpoints": {
    "public_endpoints": [
      {
        "method": "GET",
        "path": "/",
        "purpose": "Root endpoint with API info",
        "authentication": false
      },
      {
        "method": "GET",
        "path": "/health",
        "purpose": "Health check for monitoring",
        "authentication": false,
        "response_format": "{ status: 'healthy' }"
      },
      {
        "method": "POST",
        "path": "/api/v1/collections/validate",
        "purpose": "Validate access code",
        "authentication": false,
        "request_format": "{ code: string }",
        "response_format": "{ valid: boolean, collection: {...} }"
      },
      {
        "method": "POST",
        "path": "/api/v1/collections/{code}/photos",
        "purpose": "Upload photos to collection",
        "authentication": false,
        "content_type": "multipart/form-data",
        "request_format": "FormData { files: File[] }",
        "response_format": "{ uploaded: [...], failed: [...] }"
      }
    ],
    "authenticated_endpoints": [
      {
        "method": "POST",
        "path": "/api/v1/auth/login",
        "purpose": "Admin login",
        "authentication": false,
        "request_format": "{ username: string, password: string }",
        "response_format": "{ access_token: string, token_type: string, expires_in: number }"
      },
      {
        "method": "POST",
        "path": "/api/v1/admin/collections",
        "purpose": "Create new collection/access code",
        "authentication": "JWT",
        "request_format": "{ name: string, description: string, settings: {...} }",
        "response_format": "{ id: string, code: string, ... }"
      },
      {
        "method": "GET",
        "path": "/api/v1/admin/collections",
        "purpose": "List all collections with pagination",
        "authentication": "JWT",
        "query_params": "page=1&limit=20",
        "response_format": "{ items: [...], total: number, page: number }"
      },
      {
        "method": "GET",
        "path": "/api/v1/admin/collections/{code}",
        "purpose": "Get collection details",
        "authentication": "JWT",
        "response_format": "{ id: string, code: string, name: string, ... }"
      },
      {
        "method": "PATCH",
        "path": "/api/v1/admin/collections/{code}",
        "purpose": "Update collection",
        "authentication": "JWT",
        "request_format": "{ name?: string, description?: string, status?: string }"
      },
      {
        "method": "DELETE",
        "path": "/api/v1/admin/collections/{code}",
        "purpose": "Delete collection",
        "authentication": "JWT",
        "response_format": "{ success: boolean }"
      },
      {
        "method": "GET",
        "path": "/api/v1/admin/collections/{code}/photos",
        "purpose": "List photos in collection",
        "authentication": "JWT",
        "query_params": "page=1&limit=50",
        "response_format": "{ items: [...], total: number }"
      },
      {
        "method": "GET",
        "path": "/api/v1/admin/photos/{photo_id}/download",
        "purpose": "Download single photo",
        "authentication": "JWT",
        "response_format": "File stream"
      },
      {
        "method": "POST",
        "path": "/api/v1/admin/collections/{code}/photos/download",
        "purpose": "Batch download photos as ZIP",
        "authentication": "JWT",
        "request_format": "{ photo_ids: string[] }",
        "response_format": "ZIP file stream"
      },
      {
        "method": "POST",
        "path": "/api/v1/admin/collections/{code}/photos/download-all",
        "purpose": "Download all photos in collection as ZIP",
        "authentication": "JWT",
        "response_format": "ZIP file stream"
      },
      {
        "method": "DELETE",
        "path": "/api/v1/admin/photos/{photo_id}",
        "purpose": "Delete single photo",
        "authentication": "JWT",
        "response_format": "{ success: boolean }"
      },
      {
        "method": "DELETE",
        "path": "/api/v1/admin/collections/{code}/photos",
        "purpose": "Delete all photos in collection",
        "authentication": "JWT",
        "response_format": "{ success: boolean, deleted_count: number }"
      },
      {
        "method": "GET",
        "path": "/api/v1/admin/statistics",
        "purpose": "Get system statistics",
        "authentication": "JWT",
        "response_format": "{ total_collections: number, total_photos: number, total_storage_bytes: number, ... }"
      }
    ]
  },
  "file_storage_structure": {
    "base_path": "storage/",
    "upload_pattern": "storage/uploads/{collection_code}/{year}/{month}/{uuid}_{filename}",
    "thumbnail_pattern": "storage/thumbnails/{collection_code}/{year}/{month}/{uuid}_thumb.jpg",
    "thumbnail_size": "400x400",
    "supported_formats": ["jpg", "jpeg", "png", "gif", "webp"],
    "validation_strategy": "Magic numbers + MIME type check"
  },
  "key_features": {
    "user_features": [
      "Access code validation",
      "Drag-and-drop photo upload",
      "Batch photo upload",
      "Real-time upload progress",
      "Supported formats: JPG, PNG, GIF, WebP"
    ],
    "admin_features": [
      "JWT-based authentication",
      "Access code CRUD management",
      "Photo gallery with responsive grid",
      "Photo selection (single/batch)",
      "Single photo download",
      "Batch photo download (ZIP)",
      "Download all photos (ZIP)",
      "Delete single photo (with confirmation)",
      "Delete selected photos (with confirmation)",
      "Delete all photos (with double confirmation)",
      "Lightbox viewer with keyboard navigation",
      "System statistics dashboard",
      "Collection activity tracking"
    ]
  },
  "ui_design_patterns": {
    "design_style": "Modern Dashboard/Admin Panel",
    "color_scheme": "Professional blue-based palette",
    "css_framework": "Tailwind CSS (utility-first)",
    "icon_library": "Heroicons or Lucide (no emojis)",
    "design_tool": "ui-ux-pro-max skill",
    "key_components": [
      {
        "name": "StatCard",
        "purpose": "Display statistics",
        "styling": "White background, 8px border radius, subtle shadow, hover effect"
      },
      {
        "name": "PhotoGrid",
        "purpose": "Responsive photo display",
        "layout": "grid-cols-2 md:grid-cols-4 lg:grid-cols-6",
        "features": ["Checkbox overlay", "Hover mask with info", "Quick download button"]
      },
      {
        "name": "PhotoToolbar",
        "purpose": "Batch operations",
        "position": "Sticky top",
        "styling": "Glassmorphism (translucent white blur)",
        "actions": ["Select all", "Batch download", "Download all", "Delete selected", "Delete all"]
      },
      {
        "name": "Lightbox",
        "purpose": "Full-screen photo viewer",
        "styling": "Black translucent background (rgba(0,0,0,0.9))",
        "features": ["Keyboard navigation (ESC, ←, →)", "Download button", "Delete button", "Filename display"]
      }
    ],
    "responsive_breakpoints": {
      "mobile": "< 768px",
      "tablet": "768px - 1024px",
      "desktop": "> 1024px"
    }
  },
  "development_workflow": {
    "commands": {
      "install_dependencies": "pnpm install",
      "run_all_dev_servers": "pnpm dev (uses Nx)",
      "build_all": "pnpm build",
      "type_sync": "pnpm type-sync (OpenAPI → TypeScript)",
      "lint": "pnpm lint",
      "test": "pnpm test",
      "docker_up": "docker-compose up -d",
      "docker_down": "docker-compose down",
      "docker_logs": "docker-compose logs -f [service]"
    },
    "frontend_dev": {
      "web": "cd apps/web && pnpm dev (port 5173)",
      "admin": "cd apps/admin && pnpm dev (port 5174)"
    },
    "backend_dev": {
      "setup": "cd apps/server && uv venv && source .venv/bin/activate && uv pip install -e .",
      "run": "uvicorn app.main:app --reload (port 8000)"
    },
    "git_workflow": {
      "main_branch": "main",
      "feature_branches": "feature/*",
      "commit_convention": "Conventional Commits"
    }
  },
  "environment_variables": {
    "backend": {
      "MONGODB_URL": "MongoDB connection string",
      "JWT_SECRET": "Secret key for JWT signing",
      "STORAGE_PATH": "Local file storage path",
      "ENVIRONMENT": "development | production",
      "CORS_ORIGINS": "Comma-separated allowed origins"
    },
    "frontend": {
      "VITE_API_URL": "Backend API base URL"
    },
    "docker": {
      "MONGO_PASSWORD": "MongoDB root password"
    }
  },
  "dependencies": {
    "frontend_core": [
      "vue@3.4.0",
      "vue-router",
      "pinia",
      "element-plus@2.5.0",
      "axios@1.6.0",
      "typescript@5.3.2",
      "vite@5.0.0"
    ],
    "frontend_dev": [
      "vite",
      "vue-tsc@1.8.0",
      "vitest@1.6.0",
      "@vitejs/plugin-vue@5.0.0"
    ],
    "backend_core": [
      "fastapi",
      "beanie",
      "motor",
      "python-jose[cryptography]",
      "passlib[bcrypt]",
      "pillow",
      "python-multipart"
    ],
    "monorepo_tools": [
      "nx@^18.0.0",
      "@nx/vite@^18.0.0",
      "pnpm@^8.15.0"
    ]
  },
  "documentation_locations": {
    "continuation_guide": "CONTINUATION-GUIDE.md",
    "all_phases_summary": ".spec-workflow/specs/ALL-PHASES-DESIGN-SUMMARY.md",
    "implementation_checklist": ".spec-workflow/specs/IMPLEMENTATION-CHECKLIST.md",
    "phase_1_requirements": ".spec-workflow/specs/phase-1-infrastructure/requirements.md",
    "phase_1_design": ".spec-workflow/specs/phase-1-infrastructure/design.md",
    "readme": "README.md"
  },
  "next_steps": {
    "immediate": [
      "Start Phase 2: Implement JWT authentication system",
      "Create User model with bcrypt password hashing",
      "Implement login endpoint and frontend login page",
      "Add authentication middleware and route guards"
    ],
    "short_term": [
      "Phase 3: Implement access code generation and validation",
      "Phase 4: Build photo upload system with thumbnail generation",
      "Phase 5: Design beautiful admin dashboard (重点)"
    ],
    "long_term": [
      "Phase 6-7: Add statistics, search, and optimization",
      "Phase 8: Write tests and documentation",
      "Phase 9: Production deployment with HTTPS and monitoring"
    ]
  },
  "semantic_tags": [
    "monorepo",
    "photo-management",
    "vue3",
    "fastapi",
    "mongodb",
    "docker",
    "typescript",
    "python",
    "authentication",
    "file-upload",
    "admin-dashboard",
    "tailwind-css",
    "element-plus",
    "nx-workspace",
    "pnpm-workspace",
    "beanie-odm",
    "jwt-auth",
    "image-processing",
    "access-control"
  ],
  "knowledge_graph": {
    "relationships": [
      {
        "from": "apps/web",
        "to": "apps/server",
        "type": "API Consumer",
        "protocol": "REST API via Axios"
      },
      {
        "from": "apps/admin",
        "to": "apps/server",
        "type": "API Consumer",
        "protocol": "REST API via Axios"
      },
      {
        "from": "apps/server",
        "to": "mongodb",
        "type": "Data Storage",
        "protocol": "Motor async driver via Beanie ODM"
      },
      {
        "from": "apps/server",
        "to": "storage/uploads",
        "type": "File Storage",
        "protocol": "Local filesystem"
      },
      {
        "from": "nginx",
        "to": "apps/web",
        "type": "Reverse Proxy",
        "route": "/web → port 5173"
      },
      {
        "from": "nginx",
        "to": "apps/admin",
        "type": "Reverse Proxy",
        "route": "/admin → port 5174"
      },
      {
        "from": "nginx",
        "to": "apps/server",
        "type": "Reverse Proxy",
        "route": "/api → port 8000"
      },
      {
        "from": "packages/schema",
        "to": "apps/web",
        "type": "Type Sharing",
        "mechanism": "TypeScript types from OpenAPI"
      },
      {
        "from": "packages/schema",
        "to": "apps/admin",
        "type": "Type Sharing",
        "mechanism": "TypeScript types from OpenAPI"
      },
      {
        "from": "packages/ui",
        "to": "apps/web",
        "type": "Component Sharing",
        "mechanism": "Shared Vue components"
      },
      {
        "from": "packages/ui",
        "to": "apps/admin",
        "type": "Component Sharing",
        "mechanism": "Shared Vue components"
      }
    ]
  },
  "critical_files": [
    "package.json",
    "pnpm-workspace.yaml",
    "nx.json",
    "docker-compose.yml",
    ".env.example",
    "apps/server/app/main.py",
    "apps/server/app/core/config.py",
    "apps/server/app/core/database.py",
    "apps/web/src/main.ts",
    "apps/web/src/router/index.ts",
    "apps/admin/src/main.ts",
    "apps/admin/src/router/index.ts",
    "packages/schema/types.ts",
    "README.md",
    "CONTINUATION-GUIDE.md",
    ".spec-workflow/specs/ALL-PHASES-DESIGN-SUMMARY.md"
  ],
  "performance_considerations": {
    "image_optimization": "Thumbnail generation at 400x400 to reduce bandwidth",
    "lazy_loading": "Implement for photo grid to reduce initial load",
    "virtual_scrolling": "For large photo lists (1000+ items)",
    "database_indexing": "collection_code, uploaded_at, is_deleted",
    "caching": "Nx task caching for builds",
    "bundling": "Vite for fast HMR and optimized production builds"
  },
  "security_measures": [
    "bcrypt password hashing with cost factor 12",
    "JWT tokens with 24-hour expiration",
    "CORS configured for specific origins",
    "File validation via magic numbers and MIME types",
    "Rate limiting on login endpoint (planned)",
    "Authentication middleware for admin routes",
    "Input validation on all endpoints",
    "No sensitive data in git (storage/ is gitignored)"
  ]
}
